<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Map with Custom Yandex Geocoding</title>
  <style>
    html, body, #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    #yandexSearchBar {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
    }
    #searchInput {
      margin-bottom: 5px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
      width: 300px;
    }
    #results {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 3px;
      display: none;
      background: white;
      position: absolute;
      z-index: 20;
    }
    #results div {
      padding: 5px;
      cursor: pointer;
    }
    #results div:hover {
      background-color: #f0f0f0;
    }
    #address {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 15;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>

  <!-- ArcGIS API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <!-- Yandex API -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=e29817a8-e6c5-4d07-9767-ff8c8c5083d3&lang=en_US"></script>
</head>
<style>
  div.d_none{
    display: none !important;
  }

  #sidebar{
    width: 18%;
    position: absolute;
    top: 0;
    height: calc(98vh - 5px);
    background-color: #fff;
    overflow-y: auto;
    padding: 12px 16px;
    transform: translateX(-100%);
    transition: transform .3s ease;
    display: flex;
    flex-direction: column;
    gap: 24px;
    
    &.open{
      transform: translateX(0%);
    }
  }

  .polygon_info{
    padding: 4px 12px;
    box-shadow: rgba(100, 100, 111, 0.2) 0px 7px 29px 0px;
    border-radius: 4px;
    position: relative;
    transition: all .2s ease;
    cursor: pointer;
    color: #000;
    text-decoration: none;

    h4{
      font-size: 18px;
    }

    p{
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;

      >span:not(.data_sec){
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 15px;
        font-weight: 700;

        svg{
          width: 20px;
        }
      }
    }

    &:hover::after{
      content: 'Qoşuntu üçün müraciət et';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background-color: #3c6cb4f7;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: forwards changeWidthAndColor .2s;
    }
  }

  @keyframes changeWidthAndColor {
    0%{
      width: 0%;
      color: transparent;
    }

    100%{
      width: 100%;
      color: #fff;
    }
  }
</style>
<body>
  <div id="viewDiv" class=""></div>

  <div id="sidebar" class=""></div>

  <script>
    require([
      "esri/config",
      "esri/Map",
      "esri/views/MapView",
      "esri/widgets/BasemapGallery",
      "esri/Basemap",
      "esri/layers/FeatureLayer",
      "esri/geometry/Point",
      "esri/symbols/SimpleMarkerSymbol",
      "esri/PopupTemplate",
      "esri/Graphic"], (
        esriConfig,
        Map,
        MapView,
        BasemapGallery,
        Basemap,
        FeatureLayer,
        Point,
        SimpleMarkerSymbol,
        PopupTemplate,
        Graphic
      ) => {
        esriConfig.apiKey = "AAPTxy8BH1VEsoebNVZXo8HurHhh42SuvGxjqreQtPEQ022pixyqsZ9k-fU97HE4CBkdG9rgKUEGbEtqU2mHGAx8gGW8mAp5r7VR_KivLso2R39JwOhI-9d8v48xSxMo_cQO0pOkWvIg6PcBr34toS23eUG6Ess2iWPLyKdPd2ltsc4kP0LZRCUooStzJBu4yWJhSAr_3EBQcJjxUJ8Q-R9z-Xte0Fn5dtDn95cLJdIb5os.AT1_pfeJr3d2";

        const map = new Map({
          basemap: "osm/streets-relief",
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [49.9, 40.394],
          zoom: 10,
        });

        const basemapGallery = new BasemapGallery({
          view: view,
          source: [
            new Basemap({ portalItem: { id: "c6ec0420be5a4e36b57d1ef0f243b175" } }), // OSM_Street_Relief
            new Basemap({ portalItem: { id: "39858979a6ba4cfd96005bbe9bd4cf82" } }), // Satellite
            new Basemap({ portalItem: { id: "7dc6cea0b1764a1f9af2e679f642f0f5" } }), // Topographic
            new Basemap({ portalItem: { id: "c50de463235e4161b206d000587af18b" } }), // Navi
            new Basemap({ portalItem: { id: "8b3d38c0819547faa83f7b7aca80bd76" } })  // Dark Gray
          ]
        });

        view.ui.add(basemapGallery, {
          position: "top-right"
        });

        const polygonLayerUrls = [
          "https://services-ap1.arcgis.com/6teSey48gPOzUd5c/arcgis/rest/services/Baktelecom_Polygons/FeatureServer",
          "https://services-ap1.arcgis.com/6teSey48gPOzUd5c/arcgis/rest/services/Azeronline_Polygons/FeatureServer",
          "https://services-ap1.arcgis.com/6teSey48gPOzUd5c/arcgis/rest/services/AZTELECOM/FeatureServer",
          "https://services-ap1.arcgis.com/6teSey48gPOzUd5c/arcgis/rest/services/Beeonline_Polygons/FeatureServer"
        ];

        const polygonLayers = [];

        polygonLayerUrls.forEach(url => {
          const layer = new FeatureLayer({ 
            url,
            // visible: false,
          });

          layer.load().then(() => {
            map.add(layer);
            
            layer.queryExtent().then(response => {
              if (response.extent) {
                view.extent = response.extent;
              }
            });

            polygonLayers.push(layer);
          }).catch(error => {
            console.error("Error loading polygon layer: ", error);
          });
        });
        


        function showSidebar(features, sampleCoords) {
          const sidebar = document.getElementById("sidebar");
          sidebar.innerHTML = "<h3>Mövcud provayderlər</h3>";
          const [d_lat, d_lon] = sampleCoords;

          features.forEach((feature, index) => {
            const attributes = feature[0].attributes;
            sidebar.innerHTML += `
              <a class="polygon_info" href='https://e-complaint.icta.az?uid=${attributes.NAME_RT}&d_lat="${d_lat}"&d_lon="${d_lon}"' target="_blank">
                <p>
                  <span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--!Font Awesome Pro 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2025 Fonticons, Inc.--><path fill="#3c6cb4" d="M64 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l512 0c17.7 0 32-14.3 32-32l0-256c0-17.7-14.3-32-32-32L64 96zM0 128C0 92.7 28.7 64 64 64l512 0c35.3 0 64 28.7 64 64l0 256c0 35.3-28.7 64-64 64L64 448c-35.3 0-64-28.7-64-64L0 128zm176 32c6.5 0 12.4 4 14.9 10.1l64 160c3.3 8.2-.7 17.5-8.9 20.8s-17.5-.7-20.8-8.9L216.4 320l-.4 0-80 0-.4 0-8.8 21.9c-3.3 8.2-12.6 12.2-20.8 8.9s-12.2-12.6-8.9-20.8l64-160c2.4-6.1 8.3-10.1 14.9-10.1zm0 59.1L148.4 288l55.1 0L176 219.1zM288 176c0-8.8 7.2-16 16-16l56 0c30.9 0 56 25.1 56 56c0 12.1-3.8 23.3-10.4 32.5C421.5 258.4 432 276 432 296c0 30.9-25.1 56-56 56l-72 0c-8.8 0-16-7.2-16-16l0-16 0-64 0-64 0-16zm72 96l-40 0 0 48 56 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-16 0zm0-32c13.3 0 24-10.7 24-24s-10.7-24-24-24l-40 0 0 48 40 0z"/></svg>
                    Name:
                  </span> 
                  <span class="data_sec">
                    ${(attributes.NAME || attributes.Name) || "Polygon Information"}
                  </span>  
                </p>

                <p>
                  <span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#3c6cb4" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM385 215c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-71-71L280 392c0 13.3-10.7 24-24 24s-24-10.7-24-24l0-214.1-71 71c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9L239 103c9.4-9.4 24.6-9.4 33.9 0L385 215z"/></svg>
                    Upload:
                  </span> 
                  <span class="data_sec">
                    ${attributes.UPLOAD || "N/A"}
                  </span>  
                </p>

                <p>
                  <span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path fill="#3c6cb4" d="M256 0a256 256 0 1 0 0 512A256 256 0 1 0 256 0zM127 297c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l71 71L232 120c0-13.3 10.7-24 24-24s24 10.7 24 24l0 214.1 71-71c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9L273 409c-9.4 9.4-24.6 9.4-33.9 0L127 297z"/></svg>
                    Download:
                  </span> 
                  <span class="data_sec">
                    ${attributes.DOWNLOAD || "N/A"}
                  </span>  
                </p>

                <p>
                  <span>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--!Font Awesome Pro 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2025 Fonticons, Inc.--><path class="fa-secondary" opacity=".4" fill="#3c6cb4" d="M208 208l0 96 96 0 0-96-96 0z"/><path class="fa-primary" fill="#3c6cb4" d="M184 24l0-24L136 0l0 24 0 40-24 0L64 64l0 48 0 24-40 0L0 136l0 48 24 0 40 0 0 48-40 0L0 232l0 48 24 0 40 0 0 48-40 0L0 328l0 48 24 0 40 0 0 24 0 48 48 0 24 0 0 40 0 24 48 0 0-24 0-40 48 0 0 40 0 24 48 0 0-24 0-40 48 0 0 40 0 24 48 0 0-24 0-40 24 0 48 0 0-48 0-24 40 0 24 0 0-48-24 0-40 0 0-48 40 0 24 0 0-48-24 0-40 0 0-48 40 0 24 0 0-48-24 0-40 0 0-24 0-48-48 0-24 0 0-40 0-24L328 0l0 24 0 40-48 0 0-40 0-24L232 0l0 24 0 40-48 0 0-40zm216 88l0 288-288 0 0-288 288 0zm-96 96l0 96-96 0 0-96 96 0zm-96-48l-48 0 0 48 0 96 0 48 48 0 96 0 48 0 0-48 0-96 0-48-48 0-96 0z"/></svg>
                    Tech:
                  </span> 
                  <span class="data_sec">
                    ${attributes.TECH || "N/A"}
                  </span>  
                </p>
              </a>`;
          });
        }

        function checkIfPointIntersects(markerPoint, sampleCoords) {
          const intersectedPolygons = [];

          const queryPromises = polygonLayers.map(layer => {
            const query = layer.createQuery();
            query.geometry = markerPoint;
            query.spatialRelationship = "intersects";
            query.outFields = ["*"];

            return layer.queryFeatures(query)
              .then(response => {
                if (response.features.length > 0) {
                  intersectedPolygons.push(response.features)
                }
              })
              .catch(error => {
                console.error("Error querying the polygon layer: ", error);
              });
          });

          Promise.all(queryPromises).then(() => {
            if(intersectedPolygons.length){
              showSidebar(intersectedPolygons, sampleCoords);
              document.getElementById("sidebar").classList.add('open');
            } else {
              document.getElementById("sidebar").classList.remove('open');              
              console.log("Point intersects with a polygon: false");
            }

          });
        }

        view.on("click", (event) => {
          const clickPoint = event.mapPoint;
          const sampleCoords = [clickPoint.latitude, clickPoint.longitude]

          if (sampleCoords) {
              const [pinnedLatitude, pinnedLongitude] = sampleCoords; 

              view.goTo({
                center: [pinnedLongitude, pinnedLatitude], 
                zoom: 17,
              });

              const point = {
                type: "point",
                longitude: pinnedLongitude,
                latitude: pinnedLatitude,
              };

              const markedPoint = new Point({
                longitude: pinnedLongitude,
                latitude: pinnedLatitude,
              });

              const markerSymbol = new SimpleMarkerSymbol({
                color: [226, 119, 40],
                size: 10,
                outline: {
                  color: [255, 255, 255],
                  width: 2,
                },
              });

              const pointGraphic = new Graphic({
                geometry: point,
                symbol: markerSymbol,
              });

              view.graphics.removeAll(); 
              view.graphics.add(pointGraphic);

              checkIfPointIntersects(markedPoint, sampleCoords);
            }
        });
    });

  </script>
</body>
</html>
